#INCLUDE 'PROTHEUS.CH'
#INCLUDE "TOTVS.CH"

/*/{Protheus.doc} BKDSGER
BK - Atualização da tabela GERAL do banco de dados PowerBk

@Return
@author Marcos Bispo Abrahão
@since 27/09/2022
@version P12.1.25
/*/

User Function BKDSGER
Local cQuery	:= ""
Local cQueryD	:= ""
Local nErro 	:= 0
Local cErro1 	:= ""
Local cErro2 	:= ""
Local cProg		:= "BKDSGER"

BEGINCONTENT VAR cQuery
WITH GER AS (
SELECT 
	FG.EMPRESA AS EMPRESA,
	FG.NOMEEMP AS NOMEEMP,
	GETDATE() AS DATAPRC,
	FG.CONTRATO AS CONTRATO,
	FG.DESCRICAO,
	G.CN9_XXNRBK,
	FG.COMPETAM,
	FG.COMPET,
	FG.COMPETD,
	FG.EMPRESA + FG.CONTRATO + FG.COMPETAM AS CHAVE,
	SUM(FG.VALFAT) AS VALFAT,
	SUM(FG.F2VALLIQ) AS F2VALLIQ,
	SUM(FG.PREVFAT) AS PREVFAT,
	SUM(FG.DESPESA) AS DESPESAS,
	SUM(FG.CUSTO) AS CUSTOS,
	CHAVEZG
FROM 
	-- FATURAMENTO
	(SELECT 
		EMPRESA,
		NOMEEMP,
		CONTRATO,
		DESCRICAO,
		COMPETAM,
		COMPET,
		COMPETD,
		CHAVEZG,
		SUM(VALFAT) AS VALFAT,
		SUM(F2VALLIQ) AS F2VALLIQ,
		SUM(CXN_VLPREV) AS PREVFAT,
		0 AS DESPESA,
		0 AS CUSTO

		--(SELECT TOP 1 ZGCHAVE FROM 
		--	(SELECT MAX(COMPETAM+ZG_SEQ) AS ZGCHAVE
		--	FROM PowerBk.dbo.PREVDESP1 
		--	WHERE PREVDESP1.EMPRESA = FATURAMENTO.EMPRESA AND PREVDESP1.CONTRATO = FATURAMENTO.CONTRATO AND PREVDESP1.COMPETAM <= FATURAMENTO.COMPETAM
		--	GROUP BY PREVDESP1.CONTRATO,PREVDESP1.ZG_DATA
		--	) AS X
		--	ORDER BY ZGCHAVE DESC) AS CHAVEZG1

		FROM PowerBk.dbo.FATURAMENTO
		GROUP BY EMPRESA,NOMEEMP,CONTRATO,DESCRICAO,COMPETAM,COMPET,COMPETD,CHAVEZG
	UNION ALL
	-- DESPESAS
	SELECT 
		EMPRESA,
		NOMEEMP,
		CONTRATO,
		DESCRICAO,
		COMPETAM,
		COMPET,
		COMPETD,
		CHAVEZG,
		0 AS VALFAT,
		0 AS F2VALLIQ,
		0 AS PREVFAT,
		SUM(DESPESA) AS DESPESA,
		0 AS CUSTO
		--(SELECT TOP 1 ZGCHAVE FROM 
		--	(SELECT MAX(COMPETAM+ZG_SEQ) AS ZGCHAVE
		--	FROM PowerBk.dbo.PREVDESP1 
		--	WHERE PREVDESP1.EMPRESA = GASTOSGERAIS.EMPRESA AND PREVDESP1.CONTRATO = GASTOSGERAIS.CONTRATO AND PREVDESP1.COMPETAM <= GASTOSGERAIS.COMPETAM
		--	GROUP BY PREVDESP1.CONTRATO,PREVDESP1.ZG_DATA
		--	) AS X
		--	ORDER BY ZGCHAVE DESC) AS CHAVEZG1

		FROM PowerBk.dbo.GASTOSGERAIS
			GROUP BY EMPRESA,NOMEEMP,CONTRATO,DESCRICAO,COMPETAM,COMPET,COMPETD,CHAVEZG

	UNION ALL
	-- FOLHA
	SELECT 
		EMPRESA,
		NOMEEMP,
		CONTRATO,
		DESCRICAO,
		COMPETAM,
		SUBSTRING(COMPETAM,5,2) + '/' + SUBSTRING(COMPETAM,1,4) AS COMPET,
	    CONVERT(DATE,COMPETAM+'01',112) AS COMPETD,
		CHAVEZG,
		0 AS VALFAT,
		0 AS F2VALLIQ,
		0 AS PREVFAT,
		0 AS DESPESA,
		SUM(CUSTO) AS CUSTO
		FROM PowerBk.dbo.FOLHA
			GROUP BY EMPRESA,NOMEEMP,CONTRATO,DESCRICAO,COMPETAM,CHAVEZG
		) AS FG
	LEFT JOIN PowerBk.dbo.GESTORES G
  	ON	G.EMPRESA  = FG.EMPRESA 
	AND G.CONTRATO = FG.CONTRATO 
	GROUP BY FG.EMPRESA,FG.NOMEEMP,FG.CONTRATO,FG.DESCRICAO,FG.COMPETAM,FG.COMPET,FG.COMPETD,G.CN9_XXNRBK,CHAVEZG)

SELECT 
GER.* ,
GER.F2VALLIQ - GER.DESPESAS - GER.CUSTOS AS RESULTADO,
PDP1.ZG_CLT + PDP1.ZG_BENEFIC AS PREVCUSTOS,
PDP1.ZG_DESPDIV AS PREVDESP,
PDP1.ZG_DESPDIV * 0.9 AS PREVDESP09,
PDP1.ZG_DESPDIV * 1.2 AS PREVDESP12,
PDP1.ZG_VLRENTA AS PREVRESULT
  	--PDP1.ZG_DATA,
  	--PDP1.ZG_SEQ,
  	--PDP1.ZG_CLT,
  	--PDP1.ZG_ENCSOC,
  	--PDP1.ZG_VLENCSO,
  	--PDP1.ZG_AJCUSTO,
  	--PDP1.ZG_ENCAC,
  	--PDP1.ZG_VLENAC,
  	--PDP1.ZG_INSUMOS,
  	--PDP1.ZG_BENEFIC,
  	--PDP1.ZG_EQUIPAM,
  	--PDP1.ZG_UNIFORM,
  	--PDP1.ZG_DESPDIV,
  	--PDP1.ZG_TRIBUTO,
  	--PDP1.ZG_VLTRIBU,
  	--PDP1.ZG_RENTABI,
  	--PDP1.ZG_VLRENTA,
  	--PDP1.ZG_TOTAL
INTO PowerBk.dbo.GERAL
FROM GER
OUTER APPLY (SELECT TOP 1 * FROM PowerBk.dbo.PREVDESP1 PDP1 WHERE
GER.EMPRESA  = PDP1.EMPRESA AND 
GER.CONTRATO = PDP1.CONTRATO AND 
GER.CHAVEZG  = PDP1.COMPETAM+PDP1.ZG_SEQ) AS PDP1
ORDER BY GER.EMPRESA,GER.CONTRATO,GER.COMPETAM

ENDCONTENT

u_LogMemo("BKDSGER.SQL",cQuery)

If !TCIsConnected() 
  MsgAlert( "Sem conexão com o banco de dados", cPerg )
  Return( Nil )
Endif  

cQueryD := "IF OBJECT_ID(N'PowerBk.dbo.GERAL', N'U') IS NOT NULL"  
cQueryD += "   DROP TABLE PowerBk.dbo.GERAL "+CRLF
nErro   := TcSqlExec(cQueryD)

If nErro != 0
	cErro1 := TcSqlError()
EndIf

nErro   := TcSqlExec(cQuery)

If nErro != 0
	cErro2 := TcSqlError()
EndIf

u_QryResult(cProg,cQueryD+cQuery,cErro1+cErro2)

Return
